name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ master, main ]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’ç¢ºèª

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        uv sync --extra dev
        uv pip install -e .

    - name: Check for breaking changes
      run: |
        # APIã®ç ´å£Šçš„å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(base_provider\.py|main\.py|provider_factory\.py)"; then
          echo "::warning::Critical files have been modified. Please ensure backward compatibility."
        fi

    - name: Validate configuration files
      run: |
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        if [ -f "lazygit-llm/config/config.yml.example" ]; then
          python -c "import yaml; yaml.safe_load(open('lazygit-llm/config/config.yml.example'))"
          echo "Configuration file validation passed"
        fi

    - name: Check test coverage for modified files
      run: |
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
        CHANGED_PY_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' | grep -v test_ | grep lazygit-llm/lazygit_llm/ || true)
        if [ -n "$CHANGED_PY_FILES" ]; then
          echo "Modified Python files:"
          echo "$CHANGED_PY_FILES"
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          uv run pytest lazygit-llm/tests/ --cov=lazygit_llm --cov-report=term-missing --cov-fail-under=80
        fi

    - name: Run focused tests for changed modules
      run: |
        # å¤‰æ›´ã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
        CHANGED_MODULES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'lazygit-llm/lazygit_llm/' | grep '\.py$' | sed 's|lazygit-llm/lazygit_llm/||' | sed 's|\.py$||' | sed 's|/|.|g')
        
        for module in $CHANGED_MODULES; do
          if [ -f "lazygit-llm/tests/test_${module}.py" ]; then
            echo "Running tests for module: $module"
            uv run pytest "lazygit-llm/tests/test_${module}.py" -v
          fi
        done

    - name: Performance regression check
      run: |
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(provider|formatter|processor)"; then
          echo "Running performance tests due to changes in critical modules"
          uv run pytest lazygit-llm/tests/ -m performance --tb=short
        fi

    - name: Integration test suite
      run: |
        # çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        uv run pytest lazygit-llm/tests/ -m integration -v

    - name: Check for TODO/FIXME comments
      run: |
        # æ–°ã—ã„TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        NEW_TODOS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*TODO|^\+.*FIXME' || true)
        if [ -n "$NEW_TODOS" ]; then
          echo "::warning::New TODO/FIXME comments found:"
          echo "$NEW_TODOS"
        fi

  compatibility-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.9", "3.12"]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        uv sync --extra dev
        uv pip install -e .

    - name: Cross-platform compatibility test
      run: |
        # åŸºæœ¬çš„ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰
        uv run python -c "
        from lazygit_llm.main import main
        from lazygit_llm.config_manager import ConfigManager
        from lazygit_llm.message_formatter import MessageFormatter
        print('Basic imports successful on ${{ matrix.os }} with Python ${{ matrix.python-version }}')
        "

    - name: Run core functionality tests
      run: |
        uv run pytest lazygit-llm/tests/test_config_manager.py lazygit-llm/tests/test_message_formatter.py -v

  comment-pr:
    runs-on: ubuntu-latest
    needs: [pr-validation, compatibility-test]
    if: always()
    
    steps:
    - name: Comment PR with test results
      uses: actions/github-script@v7
      with:
        script: |
          const prValidation = '${{ needs.pr-validation.result }}';
          const compatibilityTest = '${{ needs.compatibility-test.result }}';
          
          let message = '## ğŸ” Pull Request Test Results\n\n';
          
          message += `- **Validation Tests**: ${prValidation === 'success' ? 'âœ… Passed' : 'âŒ Failed'}\n`;
          message += `- **Compatibility Tests**: ${compatibilityTest === 'success' ? 'âœ… Passed' : 'âŒ Failed'}\n\n`;
          
          if (prValidation === 'success' && compatibilityTest === 'success') {
            message += 'ğŸ‰ All tests passed! This PR is ready for review.';
          } else {
            message += 'âš ï¸ Some tests failed. Please check the details above and fix any issues.';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });